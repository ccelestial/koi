<%-
  partial                 = "inline_fields"
  attr_string             = attr.to_s
  nested_class            = "#{attr_string.parameterize}-nested".gsub("_", "-")
  header                  = attr_string.humanize
  singular_name           = attr_string.singularize
  singular_name_humanized = singular_name.humanize
  add_link                = "Add #{singular_name_humanized}"
  ordinal_class           = "#{attr_string}-ordinal"
  klass                   = singular_name.titlecase.gsub(" ", "").constantize
  records                 = f.object.send(attr)

  is_orderable            = (klass.has_crud? && klass.options[:orderable]) ? true : false
  records                 = records.sort_by(&:ordinal) if is_orderable

  locals_to_be_passed = {
    nested_class: nested_class,
    is_orderable: is_orderable,
    attr_string: attr_string,
    singular_name_humanized: singular_name_humanized,
    ordinal_class: ordinal_class
  }
-%>

<div class="inline-nested-form">

  <h2><%= header %></h2>

  <div class="<%= nested_class %>">

    <%- if is_orderable -%>
      <div class="inline-actions">
        <label><input type="checkbox" name="show-inline-draggable" class="show-inline-draggable" value="1" /> Allow Re-Ordering</label>
      </div>
    <%- end -%>

    <div class="<%= nested_class %>-container">
      <%= f.simple_fields_for attr, records do |record| %>
        <%= render partial, { f: record }.merge(locals_to_be_passed) %>
      <%- end -%>
      <div class="links">
        <%= link_to_add_association add_link, f, attr, partial: partial,
              render_options: { locals: locals_to_be_passed } %>
      </div>
    </div>
  </div>

</div>

<% single_content_for :javascripts do %>
  <script type="text/javascript">

    $(function() {

      $("body").on("click", ".collapser", function (event) {
        console.log(this);
        $(this).closest(".nested-fields").children(".nested-inline-fields").slideToggle("slow");
      });

      $('body').bind('cocoon:after-insert', function(event, insertedItem) {
        console.log(insertedItem);
        insertedItem.children(".nested-inline-fields").slideToggle("slow");
      });

    });

  </script>
<%- end -%>
