<% 
  id = "koi-#{ new_uuid }"
  crud_settings = resource_class.crud.find(:fields, attr)

  wrapper_opts = {}
  input_opts = {} 
  input_opts[:class] = ""
  input_opts[:id] = id

  if crud_settings
    wrapper_opts[:data] = crud_settings[:wrapper_data]
    input_opts[:class] += " form--#{crud_settings[:size]}" if crud_settings[:size]
  else
    input_opts[:class] += " form--medium"
  end
%>

<% content_for :head do %>

  <script type="text/javascript" charset="utf-8">

    $ (document).ready (function ()
    {
      var input = $ ('#<%= id %>')

      input.tagify ()

      input.tagify ('inputField').autocomplete ({

        source: <%= raw resource_class.tag_counts_on(attr.to_s.chomp('_list').pluralize).collect { |t| t.name } %>

      , position: { of: input.tagify ('containerDiv') }
      
    //, close: function (event, ui) { input.tagify ('add') }
      })

      input.closest ('form').submit (function (e)
      {
        input.tagify ('serialize')
      })

    })
  </script>

  <style type="text/css" media="all">

      .ui-autocomplete { width : 296px; }

      .ui-autocomplete-input
    {
      position : absolute; bottom: 0; left:0;
    }
      .tagify-container
    {
      position : relative;
    }

  </style>
<% end %>

<%= f.input attr, as: :string, wrapper_html: wrapper_opts, input_html: input_opts %>